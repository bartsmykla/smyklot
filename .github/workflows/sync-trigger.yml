---
# Sync Trigger workflow
# Detects changes to org-synced files and triggers re-sync
#
# This file is managed by smykla-labs/.github org sync.
# Do not edit manually - changes will be overwritten.

name: Sync Trigger

on:
  workflow_dispatch: # Manual trigger - runs full sync
  push:
    branches: ["main"]
    paths:
      # Root files from templates/
      - "CODE_OF_CONDUCT.md"
      - "CONTRIBUTING.md"
      - "LICENSE"
      - "renovate.json"
      - "SECURITY.md"
      # Issue/PR templates
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE.md"
      # Smyklot workflows
      - ".github/workflows/smyklot-poll.yml"
      - ".github/workflows/smyklot-pr-commands.yml"
      # This workflow (self-heal if modified)
      - ".github/workflows/sync-trigger.yml"
      # Sync config
      - ".github/sync-config.yml"

permissions: {}

jobs:
  detect-and-trigger:
    # Skip if triggered by smyklot bot (prevents infinite loops)
    if: github.actor != 'smyklot[bot]'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2 # Required for paths-filter to compare commits

      # Note: The paths in on.push.paths (above) determine WHEN this workflow runs.
      # The filters below categorize WHICH changes occurred to set the appropriate
      # sync flags. sync-config.yml is in push paths but sets only the config filter
      # to true (not files/smyklot); the workflow logic then triggers a full sync.
      - name: Detect changed files
        id: changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            files:
              - 'CODE_OF_CONDUCT.md'
              - 'CONTRIBUTING.md'
              - 'LICENSE'
              - 'renovate.json'
              - 'SECURITY.md'
              - '.github/ISSUE_TEMPLATE/**'
              - '.github/PULL_REQUEST_TEMPLATE.md'
              - '.github/workflows/sync-trigger.yml'
            smyklot:
              - '.github/workflows/smyklot-poll.yml'
              - '.github/workflows/smyklot-pr-commands.yml'
            config:
              - '.github/sync-config.yml'

      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Trigger sync
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_FULL_NAME: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
          CHANGED_SMYKLOT: ${{ steps.changes.outputs.smyklot }}
          CHANGED_CONFIG: ${{ steps.changes.outputs.config }}
        run: |
          # Determine sync types based on trigger
          if [[ "$EVENT_NAME" == "workflow_dispatch" || "$CHANGED_CONFIG" == "true" ]]; then
            # Manual trigger or config change = full sync
            trigger_type="manual"
            [[ "$CHANGED_CONFIG" == "true" ]] && trigger_type="config-change"
            sync_labels=true
            sync_files=true
            sync_settings=true
            sync_smyklot=true
          else
            trigger_type="file-change"
            sync_labels=false
            # Note: paths-filter outputs are strings "true"/"false", not booleans
            sync_files="$CHANGED_FILES"
            sync_settings=false
            sync_smyklot="$CHANGED_SMYKLOT"
          fi

          # Skip dispatch if no sync is needed
          if [[ "$sync_labels" != "true" && "$sync_files" != "true" && \
                "$sync_settings" != "true" && "$sync_smyklot" != "true" ]]; then
            echo "No sync needed, skipping dispatch"
            exit 0
          fi

          echo "Triggering sync:"
          echo "  type=$trigger_type"
          echo "  labels=$sync_labels"
          echo "  files=$sync_files"
          echo "  settings=$sync_settings"
          echo "  smyklot=$sync_smyklot"

          if ! gh api "repos/$REPO_OWNER/.github/dispatches" -X POST \
            -f event_type="sync-trigger" \
            -F client_payload[repo]="$REPO_NAME" \
            -F client_payload[full_name]="$REPO_FULL_NAME" \
            -F client_payload[trigger]="$trigger_type" \
            -F client_payload[sync_labels]="$sync_labels" \
            -F client_payload[sync_files]="$sync_files" \
            -F client_payload[sync_settings]="$sync_settings" \
            -F client_payload[sync_smyklot]="$sync_smyklot"; then
            echo "::error::Failed to trigger sync dispatch"
            exit 1
          fi
